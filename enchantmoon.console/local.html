<!doctype html>
<html>
<head>
	<meta charset="UTF-8">
	<title>enchantMOON.console</title>
	<link href='http://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>
	<style>
	body {
		margin: 0px;
		padding: 20px;
		background: #0f0f0f;
		color: #fefefe;
		font-family: 'Roboto', sans-serif;
	}
	#id {
		font-weight: bold;
		color: #008aff;
		font-size: 120%;
	}
	a {
		color: #008aff;
	}
	</style>
	<script src="/socket.io/socket.io.js"></script>
</head>
<body>
	<h1>enchantMOON.console</h1>

	<h2>Installing the Sticker</h2>
	<ol>
		<li>Download and install the sticker on your enchantMOON</li>
	</ol>
	<h2>Connecting enchantMOON</h2>
	<ol>
		<li>Tap the sticker to bring up the prompt, and then enter the host address, then tap OK</li>
		<li>Open JavaScript console on this window, and then call MOON.eval() with any statements you want to execute on your enchantMOON</li>
	</ol>
	<h3>Example</h3>
	<pre>
  MOON.eval('importJS(["lib/MOON.js"], function(){})');
  MOON.eval('MOON.getPaperJSON(MOON.getCurrentPage().backing)');
	</pre>
	<h2>Disconnecting enchantMOON</h2>
	<ol>
		<li>Call MOON.disconnect()</li>
		<li>Cancel the sticker on your enchantMOON</li>
	</ol>

	<script>
	//Eagle hack
	(function(){
    	function truncate(s) {
	      	if(s) {
	        	var i = s.indexOf("\ufeff\ufeff");
		        if (i < 0) {
		          return s;
		        }
	        	return s.substring(0, i);
	    	}
    	}

    	var decodePacket = io.parser.decodePacket;
	    io.parser.decodePacket = function (data) {
	    	return decodePacket(truncate(data));
    	}
  	})();

	var MOON = {
		eval: function(){},
		disconnect: function(){}
	};
	(function(){

		if(/Chrome/.test(navigator.userAgent)){
			var _log = console.log;
			console.log = function(message, style) {
				if(style){
					_log.call(console, '%c' + message, style);
				}else{
					_log.call(console, message);
				}
			};
		} else {
			var _log = console.log;
			console.log = function(message) {
				_log.call(console, message);
			};
		}

		console.history = [];
		var socket = io.connect();
		socket.on("connect", function(){
			MOON.eval = function(data){
				socket.emit("command", data);
			};
			window.moon = MOON.eval;
			MOON.disconnect = function(){
				socket.disconnect();
			}
		});
		socket.on("join", function(peer){
			console.log("join:sessionid="+peer, 'color: #005aff');
		});
		socket.on("leave", function(peer){
			console.log("leave:sessionid="+peer, 'color: #ff005a');
		});
		socket.on("proceed", function(data){
			console.history.push(data);
			try{
				console.log(data);
			}catch(e){
				console.log(e);
			}
		});
		socket.on("accept", function(data){
			console.log(data, 'color: #888888');
		});
		socket.on("console.log", function(data){
			if(typeof data == 'object'){
				console.log(data);
			} else {
				console.log(data, 'background: #333333; color: #00ff5a');	
			}
		});
	})();
	</script>
</body>
</html>